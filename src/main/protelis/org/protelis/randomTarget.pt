module org:protelis:randomTarget

def randomTarget() {
    let cityPOIs = env.get("cityPOIs")
    let randomIndex = self.nextRandomDouble() * 200
    let poi = cityPOIs.get(randomIndex)
    let poi_lat = poi.get(0)
    let poi_lon = poi.get(1)
	// env.put("DEBUG: lat", lat)
	// env.put("DEBUG: lon", lon)
	let router = self.getEnvironmentAccess().getRoutingService()
	let result = optionally(router.allowedPointClosestTo(self.getEnvironmentAccess().makePosition(poi_lat, poi_lon)))
	env.put("target", result.orElse(self.getDevicePosition()))
	result
}

let position = self.getDevicePosition()
let now = self.getCurrentTime()
let frame = 40

if (env.get("target") == [0, 0]) { randomTarget() };
rep (still <- [now, position]) {
    let stillTime = still.get(0)
    let stillPosition = still.get(1)
    if (now - stillTime > frame) {
        let isStill = position == stillPosition;
        if (isStill) { randomTarget() }
        [now, position]
    } else {
        [stillTime, stillPosition]
    }
}
